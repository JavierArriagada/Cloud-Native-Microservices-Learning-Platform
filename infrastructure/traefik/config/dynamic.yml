# =============================================================================
# Traefik Dynamic Configuration
# =============================================================================
# This file provides static service discovery for WSL2 environments
# where Docker socket access may be limited
# =============================================================================

http:
  # ===========================================================================
  # ROUTERS
  # ===========================================================================
  routers:
    # API Router
    api-router:
      entryPoints:
        - web
      rule: "PathPrefix(`/api`)"
      service: api-service
      middlewares:
        - api-stripprefix
      priority: 100

    # Dash Router
    dash-router:
      entryPoints:
        - web
      rule: "PathPrefix(`/dash`)"
      service: dash-service
      priority: 90

    # Database Admin (Adminer)
    adminer-router:
      entryPoints:
        - web
      rule: "PathPrefix(`/database`)"
      service: adminer-service
      priority: 80

    # Prometheus
    prometheus-router:
      entryPoints:
        - web
      rule: "PathPrefix(`/prometheus`)"
      service: prometheus-service
      priority: 70

    # Grafana
    grafana-router:
      entryPoints:
        - web
      rule: "PathPrefix(`/grafana`)"
      service: grafana-service
      priority: 70

    # Loki
    loki-router:
      entryPoints:
        - web
      rule: "PathPrefix(`/loki`)"
      service: loki-service
      priority: 70

    # React Router (fallback)
    react-router:
      entryPoints:
        - web
      rule: "PathPrefix(`/`)"
      service: react-service
      priority: 1

  # ===========================================================================
  # MIDDLEWARE
  # ===========================================================================
  middlewares:
    api-stripprefix:
      stripPrefix:
        prefixes:
          - "/api"

  # ===========================================================================
  # SERVICES
  # ===========================================================================
  services:
    api-service:
      loadBalancer:
        servers:
          - url: "http://mlp_api:8000"

    dash-service:
      loadBalancer:
        servers:
          - url: "http://mlp_dash:8050"

    react-service:
      loadBalancer:
        servers:
          - url: "http://mlp_react:3000"

    adminer-service:
      loadBalancer:
        servers:
          - url: "http://mlp_adminer:8080"

    prometheus-service:
      loadBalancer:
        servers:
          - url: "http://mlp_prometheus:9090"

    grafana-service:
      loadBalancer:
        servers:
          - url: "http://mlp_grafana:3000"

    loki-service:
      loadBalancer:
        servers:
          - url: "http://mlp_loki:3100"

# =============================================================================
# FIN DE DYNAMIC.YML
# =============================================================================
