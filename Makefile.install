# =============================================================================
# Makefile de InstalaciÃ³n
# Cloud-Native Microservices Learning Platform
# =============================================================================
# Comandos simplificados para instalaciÃ³n y configuraciÃ³n inicial
# =============================================================================

.PHONY: help check-requirements setup-env install-quick install-full install-dev verify clean

# Colores para output
GREEN  := \033[0;32m
YELLOW := \033[1;33m
RED    := \033[0;31m
NC     := \033[0m # No Color

# Variables
COMPOSE_FILES := -f infrastructure/docker/docker-compose.yml -f infrastructure/docker/docker-compose.dev.yml
COMPOSE := docker compose $(COMPOSE_FILES)

# =============================================================================
# Help
# =============================================================================

help: ## Mostrar esta ayuda
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸš€ Cloud-Native Microservices - InstalaciÃ³n                 â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Uso: make -f Makefile.install [comando]"
	@echo ""
	@echo "Comandos de instalaciÃ³n:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# =============================================================================
# VerificaciÃ³n de requisitos
# =============================================================================

check-requirements: ## Verificar requisitos previos (Docker, Git, etc.)
	@echo "$(YELLOW)Verificando requisitos previos...$(NC)"
	@command -v docker >/dev/null 2>&1 || { echo "$(RED)âœ— Docker no estÃ¡ instalado$(NC)"; exit 1; }
	@echo "$(GREEN)âœ“ Docker instalado:$(NC) $$(docker --version)"

	@docker compose version >/dev/null 2>&1 || { echo "$(RED)âœ— Docker Compose v2 no estÃ¡ instalado$(NC)"; exit 1; }
	@echo "$(GREEN)âœ“ Docker Compose instalado:$(NC) $$(docker compose version)"

	@docker info >/dev/null 2>&1 || { echo "$(RED)âœ— Docker daemon no estÃ¡ corriendo$(NC)"; exit 1; }
	@echo "$(GREEN)âœ“ Docker daemon corriendo$(NC)"

	@command -v git >/dev/null 2>&1 && echo "$(GREEN)âœ“ Git instalado:$(NC) $$(git --version)" || echo "$(YELLOW)âš  Git no instalado (opcional)$(NC)"

	@command -v make >/dev/null 2>&1 && echo "$(GREEN)âœ“ Make instalado$(NC)" || echo "$(YELLOW)âš  Make disponible$(NC)"
	@echo "$(GREEN)âœ“ Todos los requisitos estÃ¡n cumplidos$(NC)"

# =============================================================================
# ConfiguraciÃ³n del entorno
# =============================================================================

setup-env: ## Crear archivo .env desde .env.example
	@if [ -f .env ]; then \
		echo "$(YELLOW)âš  El archivo .env ya existe. No se sobrescribirÃ¡.$(NC)"; \
		echo "  Usa: make clean-env && make setup-env para recrearlo"; \
	else \
		cp .env.example .env; \
		echo "$(GREEN)âœ“ Archivo .env creado desde .env.example$(NC)"; \
	fi

# =============================================================================
# InstalaciÃ³n
# =============================================================================

install-quick: check-requirements setup-env ## InstalaciÃ³n rÃ¡pida (sin construir, usa imÃ¡genes base)
	@echo "$(YELLOW)InstalaciÃ³n rÃ¡pida...$(NC)"
	@echo "$(YELLOW)1/3 Levantando servicios...$(NC)"
	@$(COMPOSE) up -d
	@echo "$(YELLOW)2/3 Esperando PostgreSQL...$(NC)"
	@sleep 15
	@echo "$(YELLOW)3/3 Aplicando migraciones...$(NC)"
	@docker exec mlp-api-1 python -m alembic upgrade head 2>/dev/null || echo "$(YELLOW)âš  Migraciones no disponibles aÃºn$(NC)"
	@echo "$(GREEN)âœ“ InstalaciÃ³n rÃ¡pida completada$(NC)"
	@make show-urls

install-full: check-requirements setup-env build-all ## InstalaciÃ³n completa (construye imÃ¡genes, migraciones, seed data)
	@echo "$(YELLOW)InstalaciÃ³n completa...$(NC)"
	@echo "$(YELLOW)1/4 Levantando servicios...$(NC)"
	@$(COMPOSE) up -d
	@echo "$(YELLOW)2/4 Esperando PostgreSQL...$(NC)"
	@sleep 20
	@echo "$(YELLOW)3/4 Aplicando migraciones...$(NC)"
	@docker exec mlp-api-1 python -m alembic upgrade head
	@echo "$(YELLOW)4/4 Cargando datos de ejemplo...$(NC)"
	@docker exec mlp-api-1 python -m scripts.seed_data 2>/dev/null || echo "$(YELLOW)âš  Seed data no disponible$(NC)"
	@docker exec mlp-api-1 python -m scripts.seed_mining_data 2>/dev/null || echo "$(YELLOW)âš  Seed mining data no disponible$(NC)"
	@echo "$(GREEN)âœ“ InstalaciÃ³n completa finalizada$(NC)"
	@make show-urls

install-dev: install-full ## InstalaciÃ³n para desarrollo (con monitoreo)
	@echo "$(YELLOW)Levantando stack de monitoreo...$(NC)"
	@docker compose -f infrastructure/docker/docker-compose.monitoring.yml up -d 2>/dev/null || echo "$(YELLOW)âš  Monitoreo no disponible$(NC)"
	@echo "$(GREEN)âœ“ Entorno de desarrollo completo$(NC)"

# =============================================================================
# Build
# =============================================================================

build-all: ## Construir todas las imÃ¡genes Docker
	@echo "$(YELLOW)Construyendo imÃ¡genes Docker...$(NC)"
	@$(COMPOSE) build
	@echo "$(GREEN)âœ“ ImÃ¡genes construidas$(NC)"

build-nocache: ## Construir imÃ¡genes sin usar cachÃ©
	@echo "$(YELLOW)Construyendo imÃ¡genes sin cachÃ©...$(NC)"
	@$(COMPOSE) build --no-cache
	@echo "$(GREEN)âœ“ ImÃ¡genes construidas$(NC)"

# =============================================================================
# VerificaciÃ³n
# =============================================================================

verify: ## Verificar que todos los servicios estÃ©n corriendo
	@echo "$(YELLOW)Verificando servicios...$(NC)"
	@$(COMPOSE) ps
	@echo ""
	@echo "$(YELLOW)Probando conectividad...$(NC)"
	@curl -sf http://localhost/api/health >/dev/null && echo "$(GREEN)âœ“ API respondiendo$(NC)" || echo "$(RED)âœ— API no responde$(NC)"
	@curl -sf http://localhost:8080 >/dev/null && echo "$(GREEN)âœ“ Traefik Dashboard accesible$(NC)" || echo "$(RED)âœ— Traefik no responde$(NC)"
	@docker exec mlp-postgres-1 pg_isready -U mlp_user >/dev/null 2>&1 && echo "$(GREEN)âœ“ PostgreSQL listo$(NC)" || echo "$(RED)âœ— PostgreSQL no responde$(NC)"

show-urls: ## Mostrar URLs de acceso a servicios
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸ“ Acceso a Servicios                                       â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "  ğŸŒ Frontend:        http://localhost"
	@echo "  ğŸ“š API Docs:        http://localhost/api/docs"
	@echo "  ğŸ“Š Dashboard:       http://localhost/dash"
	@echo "  ğŸ”€ Traefik:         http://localhost:8080"
	@echo "  ğŸ“ˆ Grafana:         http://localhost:3001 (admin/admin_change_in_production)"
	@echo "  ğŸ”¥ Prometheus:      http://localhost:9090"
	@echo ""
	@echo "$(GREEN)âœ“ InstalaciÃ³n completada exitosamente$(NC)"
	@echo ""

# =============================================================================
# Datos
# =============================================================================

load-seed-data: ## Cargar datos de ejemplo
	@echo "$(YELLOW)Cargando datos de ejemplo...$(NC)"
	@docker exec mlp-api-1 python -m scripts.seed_data
	@docker exec mlp-api-1 python -m scripts.seed_mining_data
	@echo "$(GREEN)âœ“ Datos cargados$(NC)"

db-migrate: ## Aplicar migraciones de base de datos
	@echo "$(YELLOW)Aplicando migraciones...$(NC)"
	@docker exec mlp-api-1 python -m alembic upgrade head
	@echo "$(GREEN)âœ“ Migraciones aplicadas$(NC)"

db-reset: ## Resetear base de datos (âš ï¸ borra todos los datos)
	@echo "$(RED)âš ï¸  ADVERTENCIA: Esto borrarÃ¡ todos los datos de la base de datos$(NC)"
	@read -p "Â¿EstÃ¡s seguro? [y/N]: " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		$(COMPOSE) down -v; \
		$(COMPOSE) up -d postgres; \
		sleep 10; \
		$(COMPOSE) up -d; \
		sleep 10; \
		docker exec mlp-api-1 python -m alembic upgrade head; \
		echo "$(GREEN)âœ“ Base de datos reseteada$(NC)"; \
	else \
		echo "$(YELLOW)OperaciÃ³n cancelada$(NC)"; \
	fi

# =============================================================================
# Limpieza
# =============================================================================

clean-env: ## Eliminar archivo .env
	@rm -f .env
	@echo "$(GREEN)âœ“ Archivo .env eliminado$(NC)"

clean-containers: ## Detener y eliminar contenedores
	@echo "$(YELLOW)Deteniendo contenedores...$(NC)"
	@$(COMPOSE) down
	@echo "$(GREEN)âœ“ Contenedores detenidos$(NC)"

clean-volumes: ## Eliminar volÃºmenes (âš ï¸ borra datos de BD)
	@echo "$(RED)âš ï¸  ADVERTENCIA: Esto borrarÃ¡ todos los datos persistentes$(NC)"
	@read -p "Â¿EstÃ¡s seguro? [y/N]: " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		$(COMPOSE) down -v; \
		echo "$(GREEN)âœ“ VolÃºmenes eliminados$(NC)"; \
	else \
		echo "$(YELLOW)OperaciÃ³n cancelada$(NC)"; \
	fi

clean-images: ## Eliminar imÃ¡genes construidas
	@echo "$(YELLOW)Eliminando imÃ¡genes...$(NC)"
	@docker images | grep mlp | awk '{print $$3}' | xargs -r docker rmi -f
	@echo "$(GREEN)âœ“ ImÃ¡genes eliminadas$(NC)"

clean-all: clean-containers clean-volumes clean-images clean-env ## Limpieza completa (âš ï¸ elimina todo)
	@echo "$(GREEN)âœ“ Limpieza completa realizada$(NC)"

# =============================================================================
# Troubleshooting
# =============================================================================

logs: ## Ver logs de todos los servicios
	@$(COMPOSE) logs -f

logs-api: ## Ver logs solo del API
	@docker logs -f mlp-api-1

logs-db: ## Ver logs solo de PostgreSQL
	@docker logs -f mlp-postgres-1

restart-all: ## Reiniciar todos los servicios
	@echo "$(YELLOW)Reiniciando servicios...$(NC)"
	@$(COMPOSE) restart
	@echo "$(GREEN)âœ“ Servicios reiniciados$(NC)"

restart-api: ## Reiniciar solo el API
	@docker restart mlp-api-1
	@echo "$(GREEN)âœ“ API reiniciado$(NC)"

restart-db: ## Reiniciar solo PostgreSQL
	@docker restart mlp-postgres-1
	@echo "$(GREEN)âœ“ PostgreSQL reiniciado$(NC)"

shell-api: ## Abrir shell en contenedor del API
	@docker exec -it mlp-api-1 bash

shell-db: ## Abrir psql en PostgreSQL
	@docker exec -it mlp-postgres-1 psql -U mlp_user -d mlp_db

# =============================================================================
# Atajos comunes
# =============================================================================

start: ## Iniciar servicios (alias de install-quick)
	@$(COMPOSE) up -d
	@echo "$(GREEN)âœ“ Servicios iniciados$(NC)"

stop: ## Detener servicios
	@$(COMPOSE) down
	@echo "$(GREEN)âœ“ Servicios detenidos$(NC)"

status: ## Ver estado de servicios
	@$(COMPOSE) ps

# =============================================================================
# InstalaciÃ³n con un solo comando
# =============================================================================

install: ## InstalaciÃ³n completa (recomendado para nuevos usuarios)
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸš€ InstalaciÃ³n Automatizada                                 â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@make check-requirements
	@echo ""
	@make setup-env
	@echo ""
	@make build-all
	@echo ""
	@make install-full
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  âœ… InstalaciÃ³n Completada                                   â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
