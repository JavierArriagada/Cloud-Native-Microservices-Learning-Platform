# =============================================================================
# Dash App Service - Makefile
# =============================================================================
# DescripciÃ³n: Comandos para desarrollo del servicio Dash (Python Dashboard)
# Modos: Docker (default) y Local (Python local)
# =============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# Variables
SERVICE_NAME := dash
PYTHON := python3
PIP := pip3
VENV := venv
DOCKER_COMPOSE := docker compose
COMPOSE_FILE := ../../infrastructure/docker/docker-compose.yml
COMPOSE_DEV := ../../infrastructure/docker/docker-compose.dev.yml

# Colores
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m

# =============================================================================
# ðŸ“‹ AYUDA
# =============================================================================

help: ## Mostrar esta ayuda
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  Dash App Service - Comandos de Desarrollo$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Modo Docker (Recomendado):$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		grep -v "LOCAL" | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Modo Local (Python local):$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		grep "LOCAL" | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""

# =============================================================================
# ðŸ³ MODO DOCKER - DESARROLLO
# =============================================================================

dev: ## [DOCKER] Levantar servicio en modo desarrollo
	@echo "$(GREEN)ðŸ³ Levantando Dash App en Docker...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) up -d $(SERVICE_NAME)
	@echo "$(GREEN)âœ… Dash App corriendo en http://localhost/dash$(NC)"

stop: ## [DOCKER] Detener servicio
	@echo "$(YELLOW)â¹ï¸  Deteniendo Dash App...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) stop $(SERVICE_NAME)

restart: ## [DOCKER] Reiniciar servicio
	@$(MAKE) stop
	@$(MAKE) dev

logs: ## [DOCKER] Ver logs en tiempo real
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) logs -f $(SERVICE_NAME)

logs-tail: ## [DOCKER] Ver Ãºltimas 100 lÃ­neas de logs
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) logs --tail=100 $(SERVICE_NAME)

shell: ## [DOCKER] Abrir shell en container
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) exec $(SERVICE_NAME) /bin/sh

shell-root: ## [DOCKER] Abrir shell como root
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) exec -u root $(SERVICE_NAME) /bin/sh

build: ## [DOCKER] Build imagen del servicio
	@echo "$(GREEN)ðŸ”¨ Building Dash App image...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) build --no-cache $(SERVICE_NAME)
	@echo "$(GREEN)âœ… Build completado$(NC)"

rebuild: ## [DOCKER] Rebuild y reiniciar
	@$(MAKE) build
	@$(MAKE) restart

# =============================================================================
# ðŸ³ MODO DOCKER - CALIDAD DE CÃ“DIGO
# =============================================================================

lint: ## [DOCKER] Verificar cÃ³digo con ruff y black
	@echo "$(GREEN)ðŸ” Verificando cÃ³digo...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) ruff check .
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) black --check .

lint-fix: ## [DOCKER] Auto-corregir problemas
	@echo "$(GREEN)ðŸ”§ Auto-corrigiendo cÃ³digo...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) ruff check --fix .
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) black .

format: ## [DOCKER] Formatear cÃ³digo con black
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) black .

# =============================================================================
# ðŸ MODO LOCAL - SETUP
# =============================================================================

local-setup: ## [LOCAL] Configurar entorno local (virtualenv + deps)
	@echo "$(GREEN)ðŸ”§ Configurando entorno local...$(NC)"
	@if [ ! -d "$(VENV)" ]; then \
		echo "$(YELLOW)Creando virtualenv...$(NC)"; \
		$(PYTHON) -m venv $(VENV); \
	fi
	@echo "$(YELLOW)Instalando dependencias...$(NC)"
	./$(VENV)/bin/$(PIP) install -r requirements.txt
	@echo "$(GREEN)âœ… Entorno local configurado$(NC)"
	@echo "$(YELLOW)Activar con: source $(VENV)/bin/activate$(NC)"

local-clean: ## [LOCAL] Eliminar virtualenv
	@echo "$(YELLOW)ðŸ§¹ Eliminando virtualenv...$(NC)"
	rm -rf $(VENV)
	rm -rf __pycache__ .ruff_cache
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

# =============================================================================
# ðŸ MODO LOCAL - DESARROLLO
# =============================================================================

local-dev: ## [LOCAL] Ejecutar servidor local con hot-reload
	@echo "$(GREEN)ðŸš€ Iniciando Dash App local...$(NC)"
	@if [ ! -d "$(VENV)" ]; then \
		echo "$(RED)âŒ Virtualenv no existe. Ejecuta 'make local-setup' primero$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)Servidor en http://localhost:8050$(NC)"
	./$(VENV)/bin/python app/main.py

local-dev-debug: ## [LOCAL] Ejecutar con debug mode activado
	@echo "$(GREEN)ðŸ› Iniciando con debug...$(NC)"
	DASH_DEBUG=true ./$(VENV)/bin/python app/main.py

local-shell: ## [LOCAL] Abrir Python shell interactivo
	./$(VENV)/bin/python

local-ipython: ## [LOCAL] Abrir IPython shell
	@if ! ./$(VENV)/bin/pip show ipython > /dev/null 2>&1; then \
		echo "$(YELLOW)Instalando IPython...$(NC)"; \
		./$(VENV)/bin/$(PIP) install ipython; \
	fi
	./$(VENV)/bin/ipython

# =============================================================================
# ðŸ MODO LOCAL - CALIDAD
# =============================================================================

local-lint: ## [LOCAL] Verificar cÃ³digo
	@echo "$(GREEN)ðŸ” Verificando cÃ³digo...$(NC)"
	./$(VENV)/bin/ruff check .
	./$(VENV)/bin/black --check .

local-lint-fix: ## [LOCAL] Auto-corregir problemas
	@echo "$(GREEN)ðŸ”§ Auto-corrigiendo...$(NC)"
	./$(VENV)/bin/ruff check --fix .
	./$(VENV)/bin/black .

local-format: ## [LOCAL] Formatear cÃ³digo
	./$(VENV)/bin/black .

# =============================================================================
# ðŸ”§ UTILIDADES
# =============================================================================

deps-update: ## Actualizar dependencias en requirements.txt
	@echo "$(GREEN)ðŸ“¦ Actualizando dependencias...$(NC)"
	./$(VENV)/bin/$(PIP) list --outdated

deps-install: ## Instalar nueva dependencia (uso: make deps-install PKG=nombre)
	@echo "$(GREEN)ðŸ“¦ Instalando $(PKG)...$(NC)"
	./$(VENV)/bin/$(PIP) install $(PKG)
	./$(VENV)/bin/$(PIP) freeze > requirements.txt

health: ## Verificar health del servicio
	@curl -s http://localhost/dash | head -n 1 || echo "$(RED)Servicio no responde$(NC)"

health-local: ## Verificar health del servicio local
	@curl -s http://localhost:8050 | head -n 1 || echo "$(RED)Servicio no responde$(NC)"

# =============================================================================
# ðŸŽ¯ WORKFLOWS COMPLETOS
# =============================================================================

first-run: local-setup ## Primera ejecuciÃ³n (setup local)
	@echo "$(GREEN)âœ… Setup completado$(NC)"
	@echo "$(YELLOW)Siguiente: make local-dev o make dev$(NC)"

ci: ## Simular CI/CD localmente
	@$(MAKE) local-lint
	@echo "$(GREEN)âœ… CI pipeline OK$(NC)"

clean-all: local-clean ## Limpieza completa
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

# =============================================================================
# FIN DEL MAKEFILE
# =============================================================================
