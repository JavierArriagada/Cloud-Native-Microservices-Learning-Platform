# =============================================================================
# React App Service - Makefile
# =============================================================================
# Descripci√≥n: Comandos para desarrollo del servicio React + TypeScript
# Modos: Docker (default) y Local (Node.js local)
# =============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# Variables
SERVICE_NAME := react
NODE := node
NPM := npm
DOCKER_COMPOSE := docker compose
COMPOSE_FILE := ../../infrastructure/docker/docker-compose.yml
COMPOSE_DEV := ../../infrastructure/docker/docker-compose.dev.yml

# Colores
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m

# =============================================================================
# üìã AYUDA
# =============================================================================

help: ## Mostrar esta ayuda
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)  React App Service - Comandos de Desarrollo$(NC)"
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "$(YELLOW)Modo Docker (Recomendado):$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		grep -v "LOCAL" | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Modo Local (Node.js local):$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		grep "LOCAL" | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""

# =============================================================================
# üê≥ MODO DOCKER - DESARROLLO
# =============================================================================

dev: ## [DOCKER] Levantar servicio en modo desarrollo
	@echo "$(GREEN)üê≥ Levantando React App en Docker...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) up -d $(SERVICE_NAME)
	@echo "$(GREEN)‚úÖ React App corriendo en http://localhost$(NC)"

stop: ## [DOCKER] Detener servicio
	@echo "$(YELLOW)‚èπÔ∏è  Deteniendo React App...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) stop $(SERVICE_NAME)

restart: ## [DOCKER] Reiniciar servicio
	@$(MAKE) stop
	@$(MAKE) dev

logs: ## [DOCKER] Ver logs en tiempo real
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) logs -f $(SERVICE_NAME)

logs-tail: ## [DOCKER] Ver √∫ltimas 100 l√≠neas de logs
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) logs --tail=100 $(SERVICE_NAME)

shell: ## [DOCKER] Abrir shell en container
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) exec $(SERVICE_NAME) /bin/sh

shell-root: ## [DOCKER] Abrir shell como root
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) -f $(COMPOSE_DEV) exec -u root $(SERVICE_NAME) /bin/sh

build: ## [DOCKER] Build imagen del servicio
	@echo "$(GREEN)üî® Building React App image...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) build --no-cache $(SERVICE_NAME)
	@echo "$(GREEN)‚úÖ Build completado$(NC)"

rebuild: ## [DOCKER] Rebuild y reiniciar
	@$(MAKE) build
	@$(MAKE) restart

# =============================================================================
# üê≥ MODO DOCKER - TESTING
# =============================================================================

test: ## [DOCKER] Ejecutar tests
	@echo "$(GREEN)üß™ Ejecutando tests en Docker...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm test -- --run

test-watch: ## [DOCKER] Tests en modo watch
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm test

test-coverage: ## [DOCKER] Tests con coverage
	@echo "$(GREEN)üìä Tests con coverage...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm test -- --coverage

# =============================================================================
# üê≥ MODO DOCKER - CALIDAD DE C√ìDIGO
# =============================================================================

lint: ## [DOCKER] Verificar c√≥digo con ESLint
	@echo "$(GREEN)üîç Verificando c√≥digo...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm run lint

lint-fix: ## [DOCKER] Auto-corregir problemas de lint
	@echo "$(GREEN)üîß Auto-corrigiendo c√≥digo...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm run lint:fix

format: ## [DOCKER] Formatear c√≥digo con Prettier
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm run format

type-check: ## [DOCKER] Verificar tipos TypeScript
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm run type-check

# =============================================================================
# üê≥ MODO DOCKER - BUILD PRODUCCI√ìN
# =============================================================================

build-prod: ## [DOCKER] Build para producci√≥n
	@echo "$(GREEN)üèóÔ∏è  Building para producci√≥n...$(NC)"
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm $(SERVICE_NAME) npm run build
	@echo "$(GREEN)‚úÖ Build de producci√≥n completado en dist/$(NC)"

preview: ## [DOCKER] Preview del build de producci√≥n
	cd ../.. && $(DOCKER_COMPOSE) -f $(COMPOSE_FILE) run --rm --service-ports $(SERVICE_NAME) npm run preview

# =============================================================================
# üêç MODO LOCAL - SETUP
# =============================================================================

local-setup: ## [LOCAL] Instalar dependencias localmente
	@echo "$(GREEN)üîß Instalando dependencias...$(NC)"
	@if ! command -v node >/dev/null 2>&1; then \
		echo "$(RED)‚ùå Node.js no est√° instalado$(NC)"; \
		exit 1; \
	fi
	@if ! command -v npm >/dev/null 2>&1; then \
		echo "$(RED)‚ùå npm no est√° instalado$(NC)"; \
		exit 1; \
	fi
	$(NPM) install
	@echo "$(GREEN)‚úÖ Dependencias instaladas$(NC)"

local-clean: ## [LOCAL] Limpiar node_modules y cache
	@echo "$(YELLOW)üßπ Limpiando...$(NC)"
	rm -rf node_modules
	rm -rf dist
	rm -rf .vite
	rm -rf coverage
	$(NPM) cache clean --force

# =============================================================================
# üêç MODO LOCAL - DESARROLLO
# =============================================================================

local-dev: ## [LOCAL] Ejecutar servidor local con hot-reload
	@echo "$(GREEN)üöÄ Iniciando React App local...$(NC)"
	@if [ ! -d "node_modules" ]; then \
		echo "$(RED)‚ùå node_modules no existe. Ejecuta 'make local-setup' primero$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)Servidor en http://localhost:5173$(NC)"
	$(NPM) run dev

local-dev-host: ## [LOCAL] Ejecutar servidor accesible desde red
	@echo "$(GREEN)üöÄ Iniciando React App (accesible desde red)...$(NC)"
	$(NPM) run dev -- --host

local-dev-port: ## [LOCAL] Ejecutar en puerto espec√≠fico (uso: make local-dev-port PORT=3000)
	@echo "$(GREEN)üöÄ Iniciando React App en puerto $(PORT)...$(NC)"
	$(NPM) run dev -- --port $(PORT)

# =============================================================================
# üêç MODO LOCAL - TESTING
# =============================================================================

local-test: ## [LOCAL] Ejecutar tests localmente
	@echo "$(GREEN)üß™ Ejecutando tests...$(NC)"
	$(NPM) test -- --run

local-test-watch: ## [LOCAL] Tests en modo watch
	$(NPM) test

local-test-coverage: ## [LOCAL] Tests con coverage
	@echo "$(GREEN)üìä Tests con coverage...$(NC)"
	$(NPM) test -- --coverage
	@echo "$(GREEN)‚úÖ Coverage report en coverage/index.html$(NC)"

local-test-ui: ## [LOCAL] Abrir UI de tests (Vitest UI)
	$(NPM) test -- --ui

# =============================================================================
# üêç MODO LOCAL - CALIDAD
# =============================================================================

local-lint: ## [LOCAL] Verificar c√≥digo
	@echo "$(GREEN)üîç Verificando c√≥digo...$(NC)"
	$(NPM) run lint

local-lint-fix: ## [LOCAL] Auto-corregir problemas
	@echo "$(GREEN)üîß Auto-corrigiendo...$(NC)"
	$(NPM) run lint:fix

local-format: ## [LOCAL] Formatear c√≥digo
	$(NPM) run format

local-format-check: ## [LOCAL] Verificar formato
	$(NPM) run format:check

local-type-check: ## [LOCAL] Verificar tipos TypeScript
	$(NPM) run type-check

# =============================================================================
# üêç MODO LOCAL - BUILD
# =============================================================================

local-build: ## [LOCAL] Build para producci√≥n
	@echo "$(GREEN)üèóÔ∏è  Building para producci√≥n...$(NC)"
	$(NPM) run build
	@echo "$(GREEN)‚úÖ Build completado en dist/$(NC)"

local-preview: ## [LOCAL] Preview del build de producci√≥n
	@echo "$(GREEN)üëÅÔ∏è  Preview del build...$(NC)"
	$(NPM) run preview

local-analyze: ## [LOCAL] Analizar tama√±o del bundle
	@echo "$(GREEN)üìä Analizando bundle...$(NC)"
	$(NPM) run build -- --mode analyze

# =============================================================================
# üîß UTILIDADES
# =============================================================================

deps-update: ## Ver dependencias desactualizadas
	@echo "$(GREEN)üì¶ Verificando actualizaciones...$(NC)"
	$(NPM) outdated

deps-install: ## Instalar nueva dependencia (uso: make deps-install PKG=nombre)
	@echo "$(GREEN)üì¶ Instalando $(PKG)...$(NC)"
	$(NPM) install $(PKG)

deps-install-dev: ## Instalar dependencia de desarrollo (uso: make deps-install-dev PKG=nombre)
	@echo "$(GREEN)üì¶ Instalando $(PKG) como dev...$(NC)"
	$(NPM) install -D $(PKG)

deps-audit: ## Auditar vulnerabilidades
	$(NPM) audit

deps-audit-fix: ## Arreglar vulnerabilidades autom√°ticamente
	$(NPM) audit fix

health: ## Verificar health del servicio
	@curl -s http://localhost | head -n 1 || echo "$(RED)Servicio no responde$(NC)"

health-local: ## Verificar health del servicio local
	@curl -s http://localhost:5173 | head -n 1 || echo "$(RED)Servicio no responde$(NC)"

# =============================================================================
# üéØ WORKFLOWS COMPLETOS
# =============================================================================

first-run: local-setup ## Primera ejecuci√≥n (instalar deps)
	@echo "$(GREEN)‚úÖ Setup completado$(NC)"
	@echo "$(YELLOW)Siguiente: make local-dev o make dev$(NC)"

ci: ## Simular CI/CD localmente
	@$(MAKE) local-lint
	@$(MAKE) local-type-check
	@$(MAKE) local-test
	@$(MAKE) local-build
	@echo "$(GREEN)‚úÖ CI pipeline OK$(NC)"

clean-all: local-clean local-setup ## Reinstalaci√≥n limpia
	@echo "$(GREEN)‚úÖ Reinstalaci√≥n completada$(NC)"

# =============================================================================
# FIN DEL MAKEFILE
# =============================================================================
