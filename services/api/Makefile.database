# =============================================================================
# Database Operations Makefile
# =============================================================================
# DescripciÃ³n: Comandos especializados para operaciones de base de datos
# Uso: make -f Makefile.database <comando>
# O incluir desde Makefile principal
# =============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# Colores
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
RED := \033[0;31m
NC := \033[0m

# =============================================================================
# ğŸ“‹ AYUDA
# =============================================================================

help: ## Mostrar esta ayuda
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  Database Operations - Comandos Disponibles$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-30s$(NC) %s\n", $$1, $$2}'
	@echo ""

# =============================================================================
# ğŸ”„ MIGRACIONES
# =============================================================================

db-migrate: ## Aplicar migraciones pendientes
	@echo "$(GREEN)â¬†ï¸  Aplicando migraciones...$(NC)"
	docker compose exec api alembic upgrade head
	@echo "$(GREEN)âœ… Migraciones aplicadas$(NC)"

db-migrate-create: ## Crear nueva migraciÃ³n (uso: make db-migrate-create MSG="mensaje")
	@if [ -z "$(MSG)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar MSG$(NC)"; \
		echo "$(YELLOW)Uso: make db-migrate-create MSG='add users table'$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ“ Creando migraciÃ³n: $(MSG)$(NC)"
	docker compose exec api alembic revision --autogenerate -m "$(MSG)"
	@echo "$(GREEN)âœ… MigraciÃ³n creada$(NC)"
	@echo "$(YELLOW)âš ï¸  Revisa el archivo generado en services/api/alembic/versions/$(NC)"

db-migrate-down: ## Revertir Ãºltima migraciÃ³n
	@echo "$(YELLOW)â¬‡ï¸  Revirtiendo Ãºltima migraciÃ³n...$(NC)"
	docker compose exec api alembic downgrade -1
	@echo "$(GREEN)âœ… MigraciÃ³n revertida$(NC)"

db-migrate-history: ## Ver historial de migraciones
	@echo "$(BLUE)ğŸ“œ Historial de migraciones:$(NC)"
	docker compose exec api alembic history --verbose

db-migrate-current: ## Ver migraciÃ³n actual
	@echo "$(BLUE)ğŸ“ MigraciÃ³n actual:$(NC)"
	docker compose exec api alembic current -v

db-migrate-show-sql: ## Ver SQL de prÃ³xima migraciÃ³n sin aplicar
	@echo "$(BLUE)ğŸ” SQL de prÃ³xima migraciÃ³n:$(NC)"
	docker compose exec api alembic upgrade head --sql

# =============================================================================
# ğŸŒ± SEED DATA
# =============================================================================

db-seed: ## Cargar datos de ejemplo
	@echo "$(GREEN)ğŸŒ± Cargando seed data...$(NC)"
	docker compose exec api python -m scripts.seed_data
	@echo "$(GREEN)âœ… Seed data cargado$(NC)"

# =============================================================================
# ğŸ” INSPECCIÃ“N
# =============================================================================

db-shell: ## Conectar a PostgreSQL via psql
	@echo "$(BLUE)ğŸ˜ Conectando a PostgreSQL...$(NC)"
	docker compose exec postgres psql -U mlp_user -d mlp_db

db-tables: ## Listar todas las tablas
	@echo "$(BLUE)ğŸ“‹ Tablas en la base de datos:$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c "\dt"

db-describe: ## Describir estructura de una tabla (uso: make db-describe TABLE=users)
	@if [ -z "$(TABLE)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar TABLE$(NC)"; \
		echo "$(YELLOW)Uso: make db-describe TABLE=users$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ” Estructura de tabla $(TABLE):$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c "\d $(TABLE)"

db-count: ## Contar registros en una tabla (uso: make db-count TABLE=users)
	@if [ -z "$(TABLE)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar TABLE$(NC)"; \
		echo "$(YELLOW)Uso: make db-count TABLE=users$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ”¢ Contando registros en $(TABLE):$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c "SELECT COUNT(*) as total FROM $(TABLE);"

db-indexes: ## Ver Ã­ndices de una tabla (uso: make db-indexes TABLE=users)
	@if [ -z "$(TABLE)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar TABLE$(NC)"; \
		echo "$(YELLOW)Uso: make db-indexes TABLE=users$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“‘ Ãndices de tabla $(TABLE):$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c \
		"SELECT indexname, indexdef FROM pg_indexes WHERE tablename = '$(TABLE)';"

# =============================================================================
# ğŸ’¾ BACKUP Y RESTORE
# =============================================================================

db-backup: ## Crear backup de la base de datos
	@echo "$(GREEN)ğŸ’¾ Creando backup...$(NC)"
	@mkdir -p backups
	@TIMESTAMP=$$(date +%Y%m%d_%H%M%S) && \
	docker compose exec postgres pg_dump -U mlp_user mlp_db > backups/backup_$$TIMESTAMP.sql && \
	echo "$(GREEN)âœ… Backup creado: backups/backup_$$TIMESTAMP.sql$(NC)"

db-restore: ## Restaurar backup (uso: make db-restore BACKUP=backups/backup_20231220_120000.sql)
	@if [ -z "$(BACKUP)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar BACKUP$(NC)"; \
		echo "$(YELLOW)Uso: make db-restore BACKUP=backups/backup_20231220_120000.sql$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)âš ï¸  ADVERTENCIA: Esto sobrescribirÃ¡ la base de datos actual$(NC)"
	@read -p "Â¿Continuar? [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "$(GREEN)ğŸ“¥ Restaurando backup...$(NC)"
	docker compose exec -T postgres psql -U mlp_user mlp_db < $(BACKUP)
	@echo "$(GREEN)âœ… Backup restaurado$(NC)"

# =============================================================================
# ğŸ§¹ LIMPIEZA
# =============================================================================

db-reset: ## Reset completo de la base de datos (Â¡PELIGRO!)
	@echo "$(RED)âš ï¸  ADVERTENCIA: Esto eliminarÃ¡ TODOS los datos$(NC)"
	@read -p "Â¿EstÃ¡s seguro? [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "$(YELLOW)ğŸ—‘ï¸  Eliminando base de datos...$(NC)"
	docker compose down postgres
	docker volume rm mlp_postgres_data 2>/dev/null || true
	@echo "$(GREEN)ğŸš€ Recreando base de datos...$(NC)"
	docker compose up -d postgres
	@echo "$(YELLOW)â³ Esperando a que PostgreSQL estÃ© listo...$(NC)"
	@sleep 5
	@$(MAKE) -f Makefile.database db-migrate
	@echo "$(GREEN)âœ… Base de datos reseteada$(NC)"

db-drop-all-tables: ## Eliminar todas las tablas (excepto alembic_version)
	@echo "$(RED)âš ï¸  ADVERTENCIA: Esto eliminarÃ¡ todas las tablas$(NC)"
	@read -p "Â¿Continuar? [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "$(YELLOW)ğŸ—‘ï¸  Eliminando tablas...$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c \
		"DO \$\$ DECLARE r RECORD; BEGIN FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename != 'alembic_version') LOOP EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE'; END LOOP; END \$\$;"
	@echo "$(GREEN)âœ… Tablas eliminadas$(NC)"

# =============================================================================
# ğŸ¤– GENERACIÃ“N AUTOMÃTICA
# =============================================================================

db-generate-code: ## Generar Pydantic schemas y queries desde modelo SQLAlchemy (uso: make db-generate-code MODEL=user)
	@if [ -z "$(MODEL)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar MODEL$(NC)"; \
		echo "$(YELLOW)Uso: make db-generate-code MODEL=user$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ¤– Generando cÃ³digo para modelo: $(MODEL)$(NC)"
	docker compose exec api python -m scripts.generate_code $(MODEL)
	@echo "$(GREEN)âœ… CÃ³digo generado$(NC)"
	@echo "$(YELLOW)âš ï¸  Revisa los archivos generados en:$(NC)"
	@echo "  - services/api/app/models/$(MODEL).py"
	@echo "  - services/api/app/queries/$(MODEL).py"

db-generate-model: ## Generar modelo SQLAlchemy desde tabla existente (uso: make db-generate-model TABLE=users)
	@if [ -z "$(TABLE)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar TABLE$(NC)"; \
		echo "$(YELLOW)Uso: make db-generate-model TABLE=users$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ¤– Generando modelo desde tabla: $(TABLE)$(NC)"
	docker compose exec api python -m scripts.generate_model $(TABLE)
	@echo "$(GREEN)âœ… Modelo generado$(NC)"
	@echo "$(YELLOW)âš ï¸  Revisa el archivo generado en:$(NC)"
	@echo "  - services/api/app/db_models/$(TABLE).py"

# =============================================================================
# âš¡ WORKFLOWS COMPLETOS
# =============================================================================

db-new-table: ## Workflow completo para crear nueva tabla (interactivo)
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  ğŸš€ Workflow: Crear Nueva Tabla$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“ Este workflow te guiarÃ¡ paso a paso:$(NC)"
	@echo "  1. Crear modelo SQLAlchemy"
	@echo "  2. Generar migraciÃ³n"
	@echo "  3. Aplicar migraciÃ³n"
	@echo "  4. Generar Pydantic schemas y queries"
	@echo "  5. Verificar en base de datos"
	@echo ""
	@read -p "Nombre de la tabla (ej: products): " table_name && \
	read -p "Mensaje de migraciÃ³n (ej: add products table): " msg && \
	echo "" && \
	echo "$(GREEN)ğŸ“‹ Resumen:$(NC)" && \
	echo "  Tabla: $$table_name" && \
	echo "  Mensaje: $$msg" && \
	echo "" && \
	read -p "Â¿Continuar? [y/N]: " confirm && [ "$$confirm" = "y" ] && \
	echo "" && \
	echo "$(BLUE)ğŸ“ Paso 1: Crea manualmente el modelo SQLAlchemy$(NC)" && \
	echo "  Archivo: services/api/app/db_models/$$table_name.py" && \
	echo "  Importa en: services/api/app/db_models/__init__.py" && \
	echo "" && \
	read -p "Presiona ENTER cuando hayas creado el modelo..." && \
	echo "" && \
	echo "$(BLUE)ğŸ“ Paso 2: Generando migraciÃ³n...$(NC)" && \
	$(MAKE) -f Makefile.database db-migrate-create MSG="$$msg" && \
	echo "" && \
	echo "$(YELLOW)âš ï¸  Revisa el archivo de migraciÃ³n generado$(NC)" && \
	read -p "Â¿MigraciÃ³n correcta? [y/N]: " migration_ok && [ "$$migration_ok" = "y" ] && \
	echo "" && \
	echo "$(BLUE)ğŸ“ Paso 3: Aplicando migraciÃ³n...$(NC)" && \
	$(MAKE) -f Makefile.database db-migrate && \
	echo "" && \
	echo "$(BLUE)ğŸ“ Paso 4: Generando Pydantic schemas y queries...$(NC)" && \
	$(MAKE) -f Makefile.database db-generate-code MODEL=$$table_name && \
	echo "" && \
	echo "$(BLUE)ğŸ“ Paso 5: Verificando en base de datos...$(NC)" && \
	$(MAKE) -f Makefile.database db-describe TABLE=$$table_name && \
	echo "" && \
	echo "$(GREEN)âœ… Â¡Tabla creada exitosamente!$(NC)" && \
	echo "" && \
	echo "$(YELLOW)ğŸ“‹ PrÃ³ximos pasos:$(NC)" && \
	echo "  1. Actualizar __init__.py de models y queries" && \
	echo "  2. Agregar seed data en scripts/seed_data.py (opcional)" && \
	echo "  3. Hacer commit de los cambios" && \
	echo ""

db-quick-table: ## Crear tabla rÃ¡pida con parÃ¡metros (uso: make db-quick-table TABLE=products MSG="add products")
	@if [ -z "$(TABLE)" ] || [ -z "$(MSG)" ]; then \
		echo "$(RED)âŒ Error: Debes proporcionar TABLE y MSG$(NC)"; \
		echo "$(YELLOW)Uso: make db-quick-table TABLE=products MSG='add products table'$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âš¡ Workflow rÃ¡pido para tabla: $(TABLE)$(NC)"
	@echo ""
	@echo "$(YELLOW)âš ï¸  AsegÃºrate de haber creado el modelo SQLAlchemy primero$(NC)"
	@read -p "Â¿Continuar? [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo ""
	@$(MAKE) -f Makefile.database db-migrate-create MSG="$(MSG)"
	@echo ""
	@read -p "Â¿MigraciÃ³n correcta? [y/N]: " migration_ok && [ "$$migration_ok" = "y" ] || exit 1
	@echo ""
	@$(MAKE) -f Makefile.database db-migrate
	@echo ""
	@$(MAKE) -f Makefile.database db-generate-code MODEL=$(TABLE)
	@echo ""
	@$(MAKE) -f Makefile.database db-describe TABLE=$(TABLE)
	@echo ""
	@echo "$(GREEN)âœ… Tabla $(TABLE) creada y configurada$(NC)"

# =============================================================================
# ğŸ“Š ESTADÃSTICAS
# =============================================================================

db-stats: ## Ver estadÃ­sticas de la base de datos
	@echo "$(BLUE)ğŸ“Š EstadÃ­sticas de Base de Datos:$(NC)"
	@echo ""
	@echo "$(YELLOW)TamaÃ±o de la base de datos:$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c \
		"SELECT pg_size_pretty(pg_database_size('mlp_db')) as size;"
	@echo ""
	@echo "$(YELLOW)NÃºmero de tablas:$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c \
		"SELECT COUNT(*) as total_tables FROM information_schema.tables WHERE table_schema = 'public';"
	@echo ""
	@echo "$(YELLOW)TamaÃ±o de cada tabla:$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c \
		"SELECT tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size FROM pg_tables WHERE schemaname = 'public' ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;"

db-connections: ## Ver conexiones activas
	@echo "$(BLUE)ğŸ”Œ Conexiones activas:$(NC)"
	@docker compose exec postgres psql -U mlp_user -d mlp_db -c \
		"SELECT datname, usename, application_name, client_addr, state, query_start FROM pg_stat_activity WHERE datname = 'mlp_db';"

# =============================================================================
# FIN DEL MAKEFILE
# =============================================================================
